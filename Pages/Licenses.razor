@page "/licenses"
@attribute [Authorize]
@using P4LicensePortal.Models
@using System.Net.Http.Json
@using System.Security.Claims
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider

<h3>Licenses</h3>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">License Management</MudText>

    @if (loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        <MudText Class="ml-3">Loading licenses...</MudText>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
    }
    else
    {
        <MudPaper Class="pa-4 mb-4">
            <MudTable Items="@licenses" Dense="@true" Hover="@true" Bordered="@true" Striped="@true">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Active Licenses</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" 
                                 AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Tenant</MudTh>
                    <MudTh>Product</MudTh>
                    <MudTh>Max Users</MudTh>
                    <MudTh>Expires</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Features</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Tenant">@context.Tenant?.Name</MudTd>
                    <MudTd DataLabel="Product">@context.ProductCode</MudTd>
                    <MudTd DataLabel="Max Users">@context.MaxUsers</MudTd>
                    <MudTd DataLabel="Expires">@context.ExpiryDate.ToShortDateString()</MudTd>
                    <MudTd DataLabel="Created">@context.CreatedDate.ToShortDateString()</MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.IsActive && !context.IsExpired)
                        {
                            <MudChip Color="Color.Success" Size="Size.Small">Active</MudChip>
                        }
                        else if (!context.IsActive)
                        {
                            <MudChip Color="Color.Error" Size="Size.Small">Revoked</MudChip>
                        }
                        else if (context.IsExpired)
                        {
                            <MudChip Color="Color.Warning" Size="Size.Small">Expired</MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Features">
                        <MudStack Row="true">
                            @if (context.EnableReports)
                            {
                                <MudTooltip Text="Reports Enabled">
                                    <MudIcon Icon="@Icons
